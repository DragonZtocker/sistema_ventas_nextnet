{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Ventas (ordenadas por fecha)</h3>
  <div class="d-flex gap-2">
    <form id="vistaForm" method="get" class="d-flex align-items-center gap-2">
      <input type="hidden" name="inicio" value="{{ request.args.get('inicio','') }}"/>
      <input type="hidden" name="fin" value="{{ request.args.get('fin','') }}"/>
      <input type="hidden" name="consultor" value="{{ request.args.get('consultor','') }}"/>
      <input type="hidden" name="vista" id="vistaField" value="{{ vista }}"/>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="vistaSwitch" {% if vista=='compacta' %}checked{% endif %}>
        <label class="form-check-label" for="vistaSwitch">Vista compacta</label>
      </div>
    </form>
    {% if current_user.role in ["admin","user"] %}
    <a class="btn btn-success" href="{{ url_for('ventas.nueva_venta') }}">+ Nueva</a>
    {% endif %}
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <label class="form-label">Inicio</label>
    <input type="date" name="inicio" class="form-control" value="{{ request.args.get('inicio','') }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Fin</label>
    <input type="date" name="fin" class="form-control" value="{{ request.args.get('fin','') }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Consultor</label>
    <input type="text" name="consultor" class="form-control" placeholder="Nombre" value="{{ request.args.get('consultor','') }}">
  </div>
  <div class="col-auto align-self-end">
    <input type="hidden" name="vista" value="{{ vista }}">
    <button class="btn btn-primary">Filtrar</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('ventas.listar_ventas') }}">Limpiar</a>
  </div>
</form>

<div class="table-responsive">
<table class="table table-striped table-hover align-middle {% if vista=='compacta' %}compact-mode{% endif %}">
  <thead class="table-dark">
    <tr>
      <th>Fecha</th>
      <th class="compact-hide">Periodo</th>
      <th class="compact-hide">Sector</th>
      <th>Consultor</th>
      <th>Cliente</th>
      <th class="compact-hide">Origen</th>
      <th class="compact-hide">Cotización Odoo</th>
      <th class="compact-hide">Licitación</th>
      <th class="compact-hide">Servicio</th>
      <th>Plazo</th>
      <th class="compact-hide">Tipo Venta</th>
      <th class="compact-hide">FCV Nuevo</th>
      <th class="compact-hide">MRC Nuevo</th>
      <th class="compact-hide">FCV Renovado</th>
      <th class="compact-hide">MRC Inicial</th>
      <th>MRC Final</th>
      <th>Variación</th>
      <th class="compact-hide">Pago Único</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for v in ventas %}
    <tr>
      <td>{{ v.fecha }}</td>
      <td class="compact-hide">{{ v.periodo }}</td>
      <td class="compact-hide">{{ v.sector }}</td>
      <td>{{ v.nombre_consultor }}</td>
      <td>{{ v.nombre_cliente }}</td>
      <td class="compact-hide">{{ v.origen_venta }}</td>
      <td class="compact-hide">{{ v.n_cotizacion_odoo or "" }}</td>
      <td class="compact-hide">{{ v.n_licitacion or "" }}</td>
      <td class="compact-hide">{{ v.tipo_servicio }}</td>
      <td>{{ v.plazo_contrato }}</td>
      <td class="compact-hide">{{ v.tipo_venta }}</td>
      <td class="compact-hide">{{ v.fcv_nuevo|money }}</td>
      <td class="compact-hide">{{ v.mrc_nuevo|money }}</td>
      <td class="compact-hide">{{ v.fcv_renovado|money }}</td>
      <td class="compact-hide">{{ v.mrc_inicial|money }}</td>
      <td>{{ v.mrc_final|money }}</td>
      <td>{{ v.variacion|money }}</td>
      <td class="compact-hide">{{ v.pago_unico|money }}</td>
      <td class="text-end">
        {% if current_user.role in ["admin","user"] %}
        <a class="btn btn-sm btn-primary" href="{{ url_for('ventas.editar_venta', venta_id=v.id) }}">Editar</a>
        {% endif %}
        {% if current_user.role == "admin" %}
        <form method="post" action="{{ url_for('ventas.eliminar_venta', venta_id=v.id) }}" style="display:inline-block" onsubmit="return confirm('¿Eliminar registro?');">
          <button class="btn btn-sm btn-outline-danger">Eliminar</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<script>
// Toggle vista compacta/completa sin perder filtros
const sw = document.getElementById('vistaSwitch');
const field = document.getElementById('vistaField');
if(sw){
  sw.addEventListener('change', () => {
    field.value = sw.checked ? 'compacta' : 'completa';
    document.getElementById('vistaForm').submit();
  });
}
</script>
{% endblock %}
